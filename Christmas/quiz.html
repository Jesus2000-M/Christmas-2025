<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quiz</title>

<link href="https://fonts.googleapis.com/css2?family=Mountains+of+Christmas:wght@400;700&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">

<style>
html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    height: 100%;
}
body {
    font-family:Poppins,sans-serif;
    text-align:center;
    color:#0c5e31;
    background: url('White Background.jpg') no-repeat center center;
    background-size: cover;
}
.option{
    padding:14px;
    margin:10px auto;
    max-width:720px;
    background:rgba(247,255,247,0.9);
    border-radius:10px;
    font-size:20px;
    cursor:pointer;
}
.option.selected{background:#c4ffc4;}
.btn{
    margin-top:18px;
    padding:12px 26px;
    border:none;
    border-radius:10px;
    font-size:18px;
    cursor:pointer;
    color:#fff;
    background:#b30000;
}
.btn.disabled{background:#aaa;}
#timerText{font-weight:700;color:#b30000;}
#timerBarContainer{
    max-width:720px;
    height:14px;
    background:#ffe5e5;
    margin:6px auto 18px;
    border-radius:10px;
    overflow:hidden;
}
#timerBar{height:14px;background:green;}
</style>
</head>

<body>

<h2 id="welcome" style="color:#b30000;"></h2>

<div id="timerText">Time: 20s</div>
<div id="timerBarContainer"><div id="timerBar"></div></div>

<h3 id="question"></h3>
<div id="options"></div>
<button id="nextBtn" class="btn disabled" disabled onclick="nextQuestion()">Next</button>

<script>
// Prevent going back
history.pushState(null,null,location.href);
window.onpopstate=()=>history.go(1);

// FIX 1: Block direct access
let playerName = localStorage.getItem("playerName");
if(!playerName){
    window.location.href="name.html";
}

document.getElementById("welcome").innerText="Welcome, "+playerName+"!";

// Questions (UNCHANGED)
const QUESTIONS=[
  {q:"Where was Jesus born?",o:["Bethlehem","Jerusalem","Nazareth","Galilee"],a:0},
  {q:"Who brought gifts to baby Jesus?",o:["Shepherds","Wise Men","Kings","Angels"],a:1},
  {q:"What guided the Wise Men?",o:["Rainbow","Cloud","A Star","Angel"],a:2},
  {q:"Who was Jesus’ mother?",o:["Sarah","Mary","Elizabeth","Rebecca"],a:1},
  {q:"Another name for Christmas?",o:["Holy Day","Nativity","Easter","Passover"],a:1},
  {q:"Who told Mary she would have a son?",o:["Gabriel","Michael","Raphael","Uriel"],a:0},
  {q:"Joseph and Mary traveled to…",o:["Rome","Nazareth","Jerusalem","Bethlehem"],a:3},
  {q:"What did angels say to shepherds?",o:["Fear not","Go home","Run away","Be silent"],a:0},
  {q:"Jesus was laid in a…",o:["Crib","Basket","Manger","Wooden Box"],a:2},
  {q:"Christmas celebrates the ___ of Jesus.",o:["Resurrection","Birth","Baptism","Miracles"],a:1}
];

let currentIndex=parseInt(localStorage.getItem("currentIndex"))||0;
let selectedAnswers=JSON.parse(localStorage.getItem("selectedAnswers")||"[]");
while(selectedAnswers.length<QUESTIONS.length) selectedAnswers.push(null);

const QTIME=20000;
let timerId,timerEnd=parseInt(localStorage.getItem("timerEnd"))||(Date.now()+QTIME);

const nextBtn=document.getElementById("nextBtn");
const timerBar=document.getElementById("timerBar");
const timerText=document.getElementById("timerText");

function loadQuestion(){
  const q=QUESTIONS[currentIndex];
  document.getElementById("question").innerText=(currentIndex+1)+". "+q.q;

  const optDiv=document.getElementById("options");
  optDiv.innerHTML="";

  q.o.forEach((opt,i)=>{
    const d=document.createElement("div");
    d.className="option";
    d.innerText=opt;

    if(selectedAnswers[currentIndex]===i){
      d.classList.add("selected");
      nextBtn.disabled=false;
      nextBtn.classList.remove("disabled");
    }

    d.onclick=()=>{
      selectedAnswers[currentIndex]=i;
      localStorage.setItem("selectedAnswers",JSON.stringify(selectedAnswers));
      document.querySelectorAll(".option").forEach(e=>e.classList.remove("selected"));
      d.classList.add("selected");
      nextBtn.disabled=false;
      nextBtn.classList.remove("disabled");
    };
    optDiv.appendChild(d);
  });

  nextBtn.disabled=(selectedAnswers[currentIndex]===null);
  nextBtn.classList.toggle("disabled",nextBtn.disabled);

  localStorage.setItem("currentIndex",currentIndex);
  if(!localStorage.getItem("timerEnd")){
      timerEnd=Date.now()+QTIME;
      localStorage.setItem("timerEnd",timerEnd);
  }
  startTimer();
}

function startTimer(){
  clearInterval(timerId);
  updateTimer();
  timerId=setInterval(updateTimer,50);
}

function updateTimer(){
  const rem=timerEnd-Date.now();
  const seconds=Math.max(0,Math.ceil(rem/1000));
  timerText.innerText="Time: "+seconds+"s";

  // FIX 2: prevent negative width
  let pct=Math.max(0,Math.min(1,rem/QTIME));
  timerBar.style.width=(pct*100)+"%";

  if(rem<=0){
    clearInterval(timerId);
    localStorage.removeItem("timerEnd");
    nextQuestion();
  }
}

function nextQuestion(){
  clearInterval(timerId);
  localStorage.removeItem("timerEnd");
  if(currentIndex<QUESTIONS.length-1){
    currentIndex++;
    localStorage.setItem("currentIndex",currentIndex);
    loadQuestion();
  } else finishQuiz();
}

function finishQuiz(){
  const score=selectedAnswers.reduce((t,a,i)=>t+(a===QUESTIONS[i].a?1:0),0);
  localStorage.setItem("lastScore",score);

  let scores=JSON.parse(localStorage.getItem("quizScores")||"[]");
  scores.push({name:playerName,score:score});

  // FIX 3: sort scores
  scores.sort((a,b)=>b.score-a.score);

  localStorage.setItem("quizScores",JSON.stringify(scores));

  localStorage.removeItem("currentIndex");
  localStorage.removeItem("selectedAnswers");
  localStorage.removeItem("timerEnd");

  window.location.href="result.html";
}

loadQuestion();
</script>

</body>
</html>

